[{"id":"попросить_сгенерировать_код_для_графика","user_id":"bf570a1b-1d42-4c03-805c-2c49e7557d48","name":"Добавлять график к ответу","type":"filter","content":"from typing import Callable, Awaitable, Any, Optional\nimport os\nimport uuid\nimport json\nfrom io import StringIO\n\nimport pandas as pd\n\nfrom open_webui.apps.webui.models.chats import Chats\nfrom open_webui.apps.webui.models.files import Files, FileForm\nfrom open_webui.apps.webui.models.users import Users\nfrom open_webui.config import UPLOAD_DIR\nfrom open_webui.main import generate_chat_completions\n\nVIZ_DIR = \"visualizations\"\nSYSTEM_PROMPT_1 = \"\"\"\nYou are professional in financial analytics. You should help to build a Plotly chart or table based on the given data to help your intern. This plot should be very useful for financial analytic. Always fallback to table format if the chart is not so informative.\nBe concise and output the one type of chart or table that will be the most informative for the given data. Don't generate the code. Respond only with 1 sentence.\n\"\"\"\nUSER_PROMPT_1 = \"\"\"\nX = {{X_DATA}}\n\nDetermine the type of chart or table that will be the most informative for the given data.\n\"\"\"\nSYSTEM_PROMPT_2 = \"\"\"\nYou are professional in financial analytics. You should generate a Plotly chart or table based on the given data to help your intern. This plot should be very useful for financial analytic. Always fallback to table format if the chart is not so informative.\n\nThink that var X already exists in global scope and contains dataframe. You should write parameters for Plotly: data and layout.\nOutput just the content of script that defines 'layout' and 'data' variables.\nThe script should start with <script> tag and end with </script> tag.\n\nExample 1:\n\nInput:\nX = {\n \"Полное наименование\": [\"Николаев Вячеслав Константинович\", \"Евтушенков Феликс Владимирович\"],\n \"ОГРН юридического лица | ИНН физического лица\": [null, null],\n \"Основание, в силу которого лицо признается аффилированным\": [\n    \"Лицо осуществляет полномочия единоличного исполнительного...\", \n    \"Лицо является членом Совета директоров акционерного общества.\"\n ],\n \"Дата наступления основания\": [\"13.03.2021\", \"23.06.2021\"],\n \"Доля участия аффилированного лица в уставном капитале акционерного общества, %\": [0.0058, null],\n \"Доля находящихся в распоряжении аффилированного лица голосующих акций акционерного общества, %\": [0.0058, null]\n}\n\nOutput:\n<script>\n    var layout = {\n        title: 'Состав аффилированных лиц',\n    };\n\n    var data = [{\n        type: 'table',\n        header: {\n            values: Object.keys(X),\n            align: \"center\",\n            line: { width: 1, color: 'black' },\n            fill: { color: 'grey' },\n            font: { family: 'Arial', size: 12, color: 'white' },\n        },\n        cells: {\n            values: Object.values(X),\n            align: 'center',\n            line: { color: 'black', width: 1 },\n            font: { family: 'Arial', size: 11, color: ['black'] },\n        },\n    }];\n</script>\n\nExample 2:\n\nInput:\nX = {\n \"N п/п\": [1, 2],\n \"Наименование показателя\": [\"Объем голосового трафика, млрд мин. (Россия + Беларусь*)\", \"Количество мобильных абонентов, млн. абонентов. (Россия + Беларусь*)\"],\n \"Методика расчета показателя\": [\"Суммарный объем всех голосовых соединений абонентов\", \"Группа определяет в качестве...\"],\n \"6 мес. 2023\": [169.8, 86.0],\n \"6 мес. 2024\": [163.4, 87.3]\n}\n\nOutput:\n<script>\n    var layout = {\n        title: 'Основные операционные показатели',\n        barmode: 'group',\n    };\n\n    var data = [{\n        type: 'bar',\n        name: '6 мес. 2023',\n        x: X[\"Наименование показателя\"],\n        y: X[\"6 мес. 2023\"],\n    }, {\n        type: 'bar',\n        name: '6 мес. 2024',\n        x: X[\"Наименование показателя\"],\n        y: X[\"6 мес. 2024\"],\n    }];\n</script>\n\nExample 3:\n\nInput:\nX = {\n \"Наименование показателя\": [\"Нематериальные активы\", \"Основные средства\"],\n \"Пояснения\": [\"\", \"\"],\n \"На 30 сентября 2022 года\": [22221793, 17590294],\n \"На 31 декабря 2021 года\": [19762415, 17934546],\n \"На 31 декабря 2020 года\": [19090789, 17539906]\n}\n\nOutput:\n<script>\n    var layout = {\n        title: 'Показатели',\n    };\n\n    var data = [{\n        type: 'scatter',\n        name: X[\"Наименование показателя\"][0],\n        x: [\"На 31 декабря 2020 года\", \"На 31 декабря 2021 года\", \"На 30 сентября 2022 года\"],\n        y: [\"На 31 декабря 2020 года\", \"На 31 декабря 2021 года\", \"На 30 сентября 2022 года\"].map(v=>X[v][0]),\n    }, {\n        type: 'scatter',\n        name: X[\"Наименование показателя\"][1],\n        x: [\"На 31 декабря 2020 года\", \"На 31 декабря 2021 года\", \"На 30 сентября 2022 года\"],\n        y: [\"На 31 декабря 2020 года\", \"На 31 декабря 2021 года\", \"На 30 сентября 2022 года\"].map(v=>X[v][1]),\n    }, {\n        type: 'scatter',\n        name: X[\"Наименование показателя\"][2],\n        x: [\"На 31 декабря 2020 года\", \"На 31 декабря 2021 года\", \"На 30 сентября 2022 года\"],\n        y: [\"На 31 декабря 2020 года\", \"На 31 декабря 2021 года\", \"На 30 сентября 2022 года\"].map(v=>X[v][2]),\n    }];\n</script>\n\"\"\"\nUSER_PROMPT_2 = \"\"\"\n{{MESSAGE_FROM_PROMPT_1}}\n\nX = {{X_DATA}}\n\nGenerate the table or chart according to the determined type.\n\"\"\"\n\nPLOTLY_TEMPLATE = \"\"\"\n<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <script src=\"https://cdn.plot.ly/plotly-latest.min.js\"></script>\n</head>\n<body>\n    <div class=\"my-chart\" style=\"width: 100%; height: 500px;\"></div>\n    <script>\n        var X = {{X_DATA}}\n\n        {{SCRIPT}}\n\n        var charts = document.querySelectorAll('.my-chart');\n        if (charts.length !== 0) {\n            Plotly.newPlot(charts[charts.length-1], data, layout);\n        }\n    </script>\n</body>\n</html>\n\"\"\"\n\n\nclass Filter:\n    def __init__(self):\n        pass\n\n    async def outlet(\n        self,\n        body: dict,\n        __event_emitter__: Callable[[Any], Awaitable[None]],\n        __user__: Optional[dict] = None,\n        __model__: Optional[dict] = None,\n    ) -> dict:\n        print(\"OUTLET body\", json.dumps(body, ensure_ascii=False))\n        if not (\n            body.get(\"chat_id\")\n            and body.get(\"messages\")\n            and __user__\n            and \"id\" in __user__\n        ):\n            return body\n\n        chat = Chats.get_chat_by_id(body[\"chat_id\"])\n        if not (chat and chat.chat.get(\"messages\")):\n            return body\n\n        last_message = chat.chat[\"messages\"][-1]\n        used_files = set()\n        for citation in last_message.get(\"citations\", []):\n            for meta in citation.get(\"metadata\", []):\n                if meta.get(\"file_id\"):\n                    used_files.add(meta.get(\"file_id\"))\n\n        if not used_files:\n            return body\n\n        used_files = sorted(list(used_files))\n        files = Files.get_files_by_ids(used_files)\n\n        user = Users.get_user_by_id(__user__[\"id\"])\n\n        content_to_display = \"\"\n        for file in files:\n            csvs = json.loads(file.meta.get(\"csvs\", \"[]\"))\n            for csv in csvs:\n                df = pd.read_csv(StringIO(csv))\n                df = df.fillna(\"\")\n                json_x = json.dumps(df.to_dict(\"list\"), ensure_ascii=False, indent=1)\n\n                await __event_emitter__(\n                    {\n                        \"type\": \"status\",\n                        \"data\": {\n                            \"description\": \"Finding the best chart type...\",\n                            \"done\": False,\n                        },\n                    }\n                )\n\n                payload_1 = {\n                    \"model\": body[\"model\"],\n                    \"messages\": [\n                        {\"role\": \"system\", \"content\": SYSTEM_PROMPT_1},\n                        {\n                            \"role\": \"user\",\n                            \"content\": USER_PROMPT_1.replace(\"{{X_DATA}}\", json_x),\n                        },\n                    ],\n                    \"stream\": False,\n                }\n                response_1 = await generate_chat_completions(\n                    form_data=payload_1, user=user, bypass_filter=True\n                )\n                print(\"RESPONSE1\", response_1)\n                message_from_prompt_1: str = response_1[\"choices\"][0][\"message\"][\n                    \"content\"\n                ]\n\n                await __event_emitter__(\n                    {\n                        \"type\": \"status\",\n                        \"data\": {\n                            \"description\": \"Generating the chart...\",\n                            \"done\": False,\n                        },\n                    }\n                )\n\n                payload_2 = {\n                    \"model\": body[\"model\"],\n                    \"messages\": [\n                        {\"role\": \"system\", \"content\": SYSTEM_PROMPT_2},\n                        {\n                            \"role\": \"user\",\n                            \"content\": USER_PROMPT_2.replace(\n                                \"{{MESSAGE_FROM_PROMPT_1}}\", message_from_prompt_1\n                            ).replace(\"{{X_DATA}}\", json_x),\n                        },\n                    ],\n                    \"stream\": False,\n                }\n                response_2 = await generate_chat_completions(\n                    form_data=payload_2, user=user, bypass_filter=True\n                )\n                print(\"RESPONSE2\", response_2)\n                js_code: str = response_2[\"choices\"][0][\"message\"][\"content\"]\n\n                # Remove everything before <script> tag and <script> tag itself\n                if \"<script>\" in js_code:\n                    js_code = js_code[js_code.find(\"<script>\") :]\n                    js_code = js_code.replace(\"<script>\", \"\")\n                # Remove everything after </script> tag and </script> tag itself\n                if \"</script>\" in js_code:\n                    js_code = js_code[: js_code.find(\"</script>\")]\n                    js_code = js_code.replace(\"</script>\", \"\")\n\n                # Generate html content\n                html_content = PLOTLY_TEMPLATE.replace(\"{{X_DATA}}\", json_x).replace(\n                    \"{{SCRIPT}}\", js_code\n                )\n\n                content_to_display += html_content\n                content_to_display += \"\\n\\n\"\n\n        await __event_emitter__(\n            {\n                \"type\": \"status\",\n                \"data\": {\n                    \"description\": \"Generating the file...\",\n                    \"done\": False,\n                },\n            }\n        )\n        html_file_id = self.write_content_to_file(\n            content_to_display,\n            __user__[\"id\"],\n            body[\"chat_id\"],\n            \"html\",\n        )\n        body[\"messages\"][-1][\"content\"] += f\"\\n\\n{{{{HTML_FILE_ID_{html_file_id}}}}}\"\n\n        await __event_emitter__(\n            {\n                \"type\": \"status\",\n                \"data\": {\n                    \"description\": \"Done creating charts.\",\n                    \"done\": True,\n                },\n            }\n        )\n        return body\n\n    def write_content_to_file(self, content, user_id, chat_id, content_type):\n        filename = f\"{content_type}_{uuid.uuid4()}.html\"\n\n        relative_path = os.path.join(VIZ_DIR, content_type, chat_id, filename)\n        chat_dir = os.path.join(UPLOAD_DIR, relative_path)\n        file_path = os.path.join(chat_dir, filename)\n\n        os.makedirs(chat_dir, exist_ok=True)\n        with open(file_path, \"w\") as f:\n            f.write(content)\n\n        file_item = Files.insert_new_file(\n            user_id,\n            FileForm(\n                id=str(uuid.uuid4()),\n                filename=relative_path,\n                path=file_path,\n                meta={\n                    \"name\": filename,\n                    \"content_type\": \"text/html\",\n                    \"size\": len(content),\n                },\n            ),\n        )\n        return file_item.id\n","meta":{"description":"Добавить полезный график к ответу модели на основе использованных файлов","manifest":{}},"is_active":true,"is_global":true,"updated_at":1730685767,"created_at":1730552112}]